{"version":3,"file":"index.js","names":["_index","require","_constants","_stripAnsi","_interopRequireDefault","_lodash","isStringPayload","action","payload","sanitizeAction","copiedAction","cloneDeep","text","stripAnsi","statusText","initializeIPCLogger","onLogAction","process","send","sanitizedAction","type","Actions","Log","LogLevels","Debug","includes","level","Success","Info","LogAction","exports"],"sources":["../../../../src/reporter/loggers/ipc/index.ts"],"sourcesContent":["import { onLogAction } from \"../../redux/index\";\nimport { ISetStatus, ActionsUnion } from \"../../redux/types\";\nimport { Actions, LogLevels } from \"../../constants\";\nimport stripAnsi from \"strip-ansi\";\nimport cloneDeep from \"lodash.clonedeep\";\n\nconst isStringPayload = (action: ActionsUnion): action is ISetStatus =>\n  typeof action.payload === `string`;\n\n/**\n * Payload can either be a String or an Object\n * See more at integration-tests/structured-logging/__tests__/to-do.js\n */\nconst sanitizeAction = (action: ActionsUnion): ActionsUnion => {\n  const copiedAction = cloneDeep(action);\n\n  if (isStringPayload(copiedAction)) {\n    return copiedAction;\n  }\n\n  if (`text` in copiedAction.payload && copiedAction.payload.text) {\n    copiedAction.payload.text = stripAnsi(copiedAction.payload.text);\n  }\n  if (`statusText` in copiedAction.payload && copiedAction.payload.statusText) {\n    copiedAction.payload.statusText = stripAnsi(\n      copiedAction.payload.statusText,\n    );\n  }\n\n  return copiedAction;\n};\n\nexport const initializeIPCLogger = (): void => {\n  onLogAction((action: ActionsUnion) => {\n    if (!process.send) return;\n\n    const sanitizedAction = sanitizeAction(action);\n\n    // we mutate sanitizedAction but this is already deep copy of action so we should be good\n    if (sanitizedAction.type === Actions.Log) {\n      // Don't emit Debug over IPC\n      if (\n        [LogLevels.Debug].includes(sanitizedAction.payload.level as LogLevels)\n      ) {\n        return;\n      }\n      // Override Success and Log types to Info over IPC\n      if (\n        [LogLevels.Success, LogLevels.Log].includes(\n          sanitizedAction.payload.level as LogLevels,\n        )\n      ) {\n        sanitizedAction.payload.level = LogLevels.Info;\n      }\n    }\n\n    process.send({\n      type: Actions.LogAction,\n      action: sanitizedAction,\n    });\n  });\n};\n"],"mappings":";;;;;AAAA,IAAAA,MAAA,GAAAC,OAAA;AAEA,IAAAC,UAAA,GAAAD,OAAA;AACA,IAAAE,UAAA,GAAAC,sBAAA,CAAAH,OAAA;AACA,IAAAI,OAAA,GAAAD,sBAAA,CAAAH,OAAA;AAEA,MAAMK,eAAe,GAAIC,MAAoB,IAC3C,OAAOA,MAAM,CAACC,OAAO,KAAM,QAAO;;AAEpC;AACA;AACA;AACA;AACA,MAAMC,cAAc,GAAIF,MAAoB,IAAmB;EAC7D,MAAMG,YAAY,GAAG,IAAAC,eAAS,EAACJ,MAAM,CAAC;EAEtC,IAAID,eAAe,CAACI,YAAY,CAAC,EAAE;IACjC,OAAOA,YAAY;EACrB;EAEA,IAAK,MAAK,IAAIA,YAAY,CAACF,OAAO,IAAIE,YAAY,CAACF,OAAO,CAACI,IAAI,EAAE;IAC/DF,YAAY,CAACF,OAAO,CAACI,IAAI,GAAG,IAAAC,kBAAS,EAACH,YAAY,CAACF,OAAO,CAACI,IAAI,CAAC;EAClE;EACA,IAAK,YAAW,IAAIF,YAAY,CAACF,OAAO,IAAIE,YAAY,CAACF,OAAO,CAACM,UAAU,EAAE;IAC3EJ,YAAY,CAACF,OAAO,CAACM,UAAU,GAAG,IAAAD,kBAAS,EACzCH,YAAY,CAACF,OAAO,CAACM,UACvB,CAAC;EACH;EAEA,OAAOJ,YAAY;AACrB,CAAC;AAEM,MAAMK,mBAAmB,GAAGA,CAAA,KAAY;EAC7C,IAAAC,kBAAW,EAAET,MAAoB,IAAK;IACpC,IAAI,CAACU,OAAO,CAACC,IAAI,EAAE;IAEnB,MAAMC,eAAe,GAAGV,cAAc,CAACF,MAAM,CAAC;;IAE9C;IACA,IAAIY,eAAe,CAACC,IAAI,KAAKC,kBAAO,CAACC,GAAG,EAAE;MACxC;MACA,IACE,CAACC,oBAAS,CAACC,KAAK,CAAC,CAACC,QAAQ,CAACN,eAAe,CAACX,OAAO,CAACkB,KAAkB,CAAC,EACtE;QACA;MACF;MACA;MACA,IACE,CAACH,oBAAS,CAACI,OAAO,EAAEJ,oBAAS,CAACD,GAAG,CAAC,CAACG,QAAQ,CACzCN,eAAe,CAACX,OAAO,CAACkB,KAC1B,CAAC,EACD;QACAP,eAAe,CAACX,OAAO,CAACkB,KAAK,GAAGH,oBAAS,CAACK,IAAI;MAChD;IACF;IAEAX,OAAO,CAACC,IAAI,CAAC;MACXE,IAAI,EAAEC,kBAAO,CAACQ,SAAS;MACvBtB,MAAM,EAAEY;IACV,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ,CAAC;AAACW,OAAA,CAAAf,mBAAA,GAAAA,mBAAA"}