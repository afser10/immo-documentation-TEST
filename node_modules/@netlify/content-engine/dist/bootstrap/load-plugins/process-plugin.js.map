{"version":3,"file":"process-plugin.js","names":["_createId","require","_resolvePlugin","_lodash","_interopRequireDefault","_lodash2","_lodash3","processPlugin","plugin","rootDir","parentDir","info","resolvePlugin","pluginOptions","plugins","options","isEmpty","option","Error","resolve","subPluginPaths","subPluginPath","segments","split","roots","pathToSwap","segment","slice","length","flat","map","root","processed","result","push","set","name","id","createPluginId","version","modulePath","module","Array","from","undefined","merge"],"sources":["../../../src/bootstrap/load-plugins/process-plugin.ts"],"sourcesContent":["import { IPluginInfo, PluginRef } from \"./types\";\nimport { createPluginId } from \"./utils/create-id\";\nimport { resolvePlugin } from \"./resolve-plugin\";\nimport set from \"lodash.set\";\nimport merge from \"lodash.merge\";\nimport isEmpty from \"lodash.isempty\";\n\nexport function processPlugin(plugin: PluginRef, rootDir: string): IPluginInfo {\n  // Respect the directory that the plugin was sourced from initially\n  rootDir = (typeof plugin !== `string` && plugin.parentDir) || rootDir;\n\n  if (typeof plugin === `string`) {\n    const info = resolvePlugin(plugin, rootDir);\n\n    return {\n      ...info,\n      pluginOptions: {\n        plugins: [],\n      },\n    };\n  }\n\n  plugin.options = plugin.options || {};\n\n  // Throw an error if there is an \"option\" key.\n  if (\n    isEmpty(plugin.options) &&\n    !isEmpty((plugin as { option?: unknown }).option)\n  ) {\n    throw new Error(\n      `Plugin \"${plugin.resolve}\" has an \"option\" key in the configuration. Did you mean \"options\"?`,\n    );\n  }\n\n  // Plugins can have plugins.\n  if (plugin.subPluginPaths) {\n    for (const subPluginPath of plugin.subPluginPaths) {\n      const segments = subPluginPath.split(`.`);\n      let roots: Array<any> = [plugin.options];\n\n      let pathToSwap = segments;\n\n      for (const segment of segments) {\n        if (segment === `[]`) {\n          pathToSwap = pathToSwap.slice(0, pathToSwap.length - 1);\n          roots = roots.flat();\n        } else {\n          roots = roots.map((root) => root[segment]);\n        }\n      }\n      roots = roots.flat();\n\n      const processed: Array<IPluginInfo> = [];\n\n      for (const root of roots) {\n        const result = processPlugin(root, rootDir);\n        processed.push(result);\n      }\n\n      set(plugin.options, pathToSwap, processed);\n    }\n  }\n\n  // Add some default values for tests as we don't actually\n  // want to try to load anything during tests.\n  if (plugin.resolve === `___TEST___`) {\n    const name = `TEST`;\n\n    return {\n      id: createPluginId(name, plugin),\n      name,\n      version: `0.0.0-test`,\n      pluginOptions: {\n        plugins: [],\n      },\n      resolve: `__TEST__`,\n    };\n  }\n\n  const info = resolvePlugin(plugin, rootDir);\n\n  return {\n    ...info,\n    modulePath: plugin.modulePath,\n    module: plugin.module,\n    subPluginPaths: plugin.subPluginPaths\n      ? Array.from(plugin.subPluginPaths)\n      : undefined,\n    id: createPluginId(info.name, plugin),\n    pluginOptions: merge({ plugins: [] }, plugin.options),\n  };\n}\n"],"mappings":"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"}